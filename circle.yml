machine:
  python:
    version: "3.5.2"

dependencies:
  pre:
    - pip install pytest pytest-cov fakeredis hypothesis
    - pip install flake8 flake8-docstrings flake8-isort flake8-mutable flake8-debugger flake8-comprehensions flake8-todo
    - sudo apt-get update ; sudo apt-get install python3 python3-setuptools
    - gem install fpm
  override:
    - rm -rf jacquard_split.egg-info
    - pip install -e .

test:
  pre:
    - find . -name '__pycache__' -or -name '*.pyc' | xargs rm -rf
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/pytest
    - py.test -v --cov=jacquard --junit-xml=$CIRCLE_TEST_REPORTS/pytest/junit.xml jacquard
    - flake8 --exclude=tests jacquard
  post:
    - ./hax_debian.sh
    - mv *.deb $CIRCLE_ARTIFACTS/

deployment:
  release:
    tag: /[0-9]+(\.[0-9]+)*/
    owner: prophile
    commands:
      - pip install twine wheel
      - rm -rf dist
      - python setup.py sdist bdist_wheel
      - twine upload dist/*
